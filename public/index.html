<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Rate the Concert üéµ</title>

<style>
  :root {
    --bg: #0f1724;
    --card: #0b1220;
    --accent: #ff6b6b;
    --muted: #9aa4b2;
  }

  * { box-sizing: border-box; }

  body {
    margin: 0;
    min-height: 100vh;
    font-family: Inter, system-ui, sans-serif;
    background: linear-gradient(180deg, #071027 0%, #081226 50%, #08121b 100%);
    color: #e6eef6;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
  }

  /* ===== Brand bar (logo + name) ===== */
  .brand-bar {
    position: fixed;
    top: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 6px 12px;
    z-index: 2000;
    background: rgba(0,0,0,0.18);
    border-radius: 10px;
    backdrop-filter: blur(6px);
    -webkit-backdrop-filter: blur(6px);
    box-shadow: 0 6px 24px rgba(0,0,0,0.4);
  }

  .brand-logo {
    width: 202px;
    height: auto;
    border-radius: 8px;
    flex-shrink: 0;
    box-shadow: 0 4px 14px rgba(0,0,0,0.5);
  }

  /* Comic Sans neon-style text */
  .neon-text {
    font-family: "Comic Sans MS", "Comic Sans", cursive;
    font-size: 26px;
    font-weight: 700;
    letter-spacing: 1.5px;
    color: #fff56e;
    -webkit-text-stroke: 1px rgba(0,0,0,0.9);
    text-shadow:
      0 0 2px rgba(0,0,0,0.8),
      0 0 6px #fff56e,
      0 0 12px #ffe66b,
      0 0 20px #ffdb4d;
    animation: comicGlow 6s infinite ease-in-out;
    transition: transform 0.25s ease;
  }

  .neon-text:hover {
    transform: scale(1.03) translateY(-1px);
  }

  @keyframes comicGlow {
    0%, 100% {
      text-shadow:
        0 0 2px rgba(0,0,0,0.8),
        0 0 8px #fff56e,
        0 0 14px #ffe66b,
        0 0 22px #ffd84d;
      opacity: 1;
    }
    50% {
      text-shadow:
        0 0 2px rgba(0,0,0,0.8),
        0 0 5px #fff56e,
        0 0 10px #ffe66b;
      opacity: 0.92;
    }
  }

  @media (max-width:600px) {
    .neon-text { font-size: 18px; letter-spacing: 1px; }
    .brand-logo { width: 80px; height: auto; top: 40px;}
    .brand-bar { top: 6px; padding: 4px 8px; gap: 8px; }
  }

  /* ===== CARD ===== */
  .card {
    width: 100%;
    max-width: 720px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius: 14px;
    padding: 22px;
    box-shadow: 0 8px 30px rgba(2,6,23,0.6);
    border: 1px solid rgba(255,255,255,0.03);
  }

  header { display: flex; gap: 12px; align-items: center; }
  .logo {
    width: 56px; height: 56px; border-radius: 10px;
    background: linear-gradient(135deg, var(--accent), #e8cfcf);
    display: flex; align-items: center; justify-content: center; 
    font-weight: 700; color: #071220; font-size: 18px;
  }
  h1 { margin: 0; font-size: 20px; }
  p.lead { margin: 6px 0 18px; color: var(--muted); }

  .slider-wrap { display: flex; align-items: center; gap: 16px; }
  input[type="range"] {
    flex: 1;
    -webkit-appearance: none;
    height: 6px;
    border-radius: 6px;
    background: linear-gradient(90deg, var(--accent), #ffb3b3);
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 40px; height: 40px; border-radius: 50%;
    background: white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    border: 6px solid rgba(255,255,255,0.9);
  }

  /* ===== PEACH RATING ===== */
  .rating-bubble {
    position: relative;
    width: 64px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: transform 0.2s ease, box-shadow 0.4s ease;
  }

  .peach { font-size: 54px; line-height: 1; transition: filter 0.4s ease; }

  .rating-count {
    position: absolute;
    top: 55%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-weight: 800;
    font-size: 20px;
    color: #3a0b00;
    text-shadow: 0 0 4px rgba(255,255,255,0.8);
    pointer-events: none;
  }

  /* ===== GLOW EFFECTS (1‚Äì10) ===== */
  .glow-1  { box-shadow: 0 0 8px rgba(255, 60, 60, 0.3);  filter: drop-shadow(0 0 6px rgba(255, 60, 60, 0.4)); }
  .glow-2  { box-shadow: 0 0 10px rgba(255, 90, 60, 0.4); filter: drop-shadow(0 0 8px rgba(255, 90, 60, 0.5)); }
  .glow-3  { box-shadow: 0 0 12px rgba(255, 120, 70, 0.5); filter: drop-shadow(0 0 10px rgba(255, 120, 70, 0.6)); }
  .glow-4  { box-shadow: 0 0 14px rgba(255, 140, 70, 0.6); filter: drop-shadow(0 0 12px rgba(255, 140, 70, 0.7)); }
  .glow-5  { box-shadow: 0 0 16px rgba(255, 160, 80, 0.7); filter: drop-shadow(0 0 14px rgba(255, 160, 80, 0.8)); }
  .glow-6  { box-shadow: 0 0 18px rgba(255, 180, 100, 0.8); filter: drop-shadow(0 0 15px rgba(255, 180, 100, 0.9)); }
  .glow-7  { box-shadow: 0 0 20px rgba(255, 200, 120, 0.9); filter: drop-shadow(0 0 16px rgba(255, 200, 120, 1)); }
  .glow-8  { box-shadow: 0 0 24px rgba(255, 220, 140, 1);   filter: drop-shadow(0 0 18px rgba(255, 220, 140, 1)); }
  .glow-9  { box-shadow: 0 0 26px rgba(255, 235, 160, 1);   filter: drop-shadow(0 0 20px rgba(255, 235, 160, 1)); }
  .glow-10 { box-shadow: 0 0 30px rgba(255, 255, 180, 1);   filter: drop-shadow(0 0 24px rgba(255, 255, 180, 1)); }

  @keyframes pop { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
  .peach.pop { animation: pop 0.4s ease; }

  /* ===== BUTTONS ===== */
  .controls { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
  button { padding: 10px 18px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; transition: background 0.3s ease, transform 0.2s ease; }
  button:hover { transform: translateY(-2px); }
  button.primary { background: linear-gradient(180deg, var(--accent), #ff8a8a); color: #071220; }
  button.secondary { background: transparent; border: 1px solid rgba(255,255,255,0.1); color: var(--muted); }

  .muted { color: var(--muted); font-size: 14px; margin-top: 12px; }

  .modal {
    position: fixed; left: 50%; top: 50%; transform: translate(-50%, -50%);
    background: #081224; padding: 18px; border-radius: 12px; text-align: center;
    border: 1px solid rgba(255,255,255,0.1); display: none;
  }

  @media (max-width:480px) {
    .rating-bubble { width: 56px; height: 56px; }
    .peach { font-size: 46px; }
  }
</style>
</head>

<body>
  <!-- Brand bar (center top) -->
  <div class="brand-bar" role="banner">
    <img src="/images/logo.png" alt="Nonsane-sible logo" class="brand-logo" />
  </div>

  <div class="card" role="main" aria-labelledby="pageTitle">
    <header>
      <div class="logo">ü´¶</div>
      <div>
        <h1 id="pageTitle">Juicy Points!! üí¶ </h1>
        <p class="lead">Slide to pick a rating from 1 to 10. Quick and anonymous.</p>
      </div>
    </header>

    <div style="margin-top: 18px;">
      <div class="slider-wrap">
        <input id="slider" type="range" min="1" max="10" value="8" step="1" aria-label="Rating slider">
        <div class="rating-bubble" id="bubble">
          <span class="peach">üçë</span>
          <span class="rating-count" id="rating-count">8</span>
        </div>
      </div>

      <div class="controls">
        <button id="submitBtn" class="primary">Submit rating</button>
        <button id="resetBtn" class="secondary">Change rating</button>
        <div style="flex:1"></div>
        <div class="muted" id="status">You have not submitted yet.</div>
      </div>

      <p class="muted" id="currentInfo">Loading current totals‚Ä¶</p>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div style="font-size:22px;font-weight:700;margin-bottom:6px" id="modalTitle">Thanks!</div>
    <div class="muted" id="modalText">Your rating has been recorded.</div>
    <div style="height:12px"></div>
    <button id="modalClose" class="primary">Close</button>
  </div>

<script>
(async function(){
  const slider = document.getElementById('slider');
  const bubble = document.getElementById('bubble');
  const peach = bubble.querySelector('.peach');
  const count = document.getElementById('rating-count');
  const submitBtn = document.getElementById('submitBtn');
  const resetBtn = document.getElementById('resetBtn');
  const status = document.getElementById('status');
  const currentInfo = document.getElementById('currentInfo');
  const modal = document.getElementById('modal');
  const modalClose = document.getElementById('modalClose');

  const SUBMITTED_KEY = 'concert_feedback_submitted';
  const SUBMITTED_AT_KEY = 'concert_feedback_submitted_at';

  function getSubmitted() {
    const raw = localStorage.getItem(SUBMITTED_KEY) === 'true';
    const at = localStorage.getItem(SUBMITTED_AT_KEY);
    return { submitted: raw, at: at ? new Date(at) : null };
  }
  function setSubmittedNow() {
    localStorage.setItem(SUBMITTED_KEY, 'true');
    localStorage.setItem(SUBMITTED_AT_KEY, new Date().toISOString());
  }
  function clearSubmittedLocal() {
    localStorage.removeItem(SUBMITTED_KEY);
    localStorage.removeItem(SUBMITTED_AT_KEY);
  }
  function setSubmittedUI(flag) {
    if(flag) {
      status.textContent = 'You already submitted ‚Äî thanks!';
      submitBtn.disabled = true;
      submitBtn.style.opacity = 0.6;
    } else {
      status.textContent = 'You have not submitted yet.';
      submitBtn.disabled = false;
      submitBtn.style.opacity = 1;
    }
  }

  // Initialize bubble value visual
  count.textContent = slider.value;
  bubble.className = 'rating-bubble glow-' + slider.value;
  peach.className = 'peach glow-' + slider.value;

  // Dynamic glow + animation
  slider.addEventListener('input', () => {
    const value = Number(slider.value);
    count.textContent = value;
    // reset classes then add glow/pop
    bubble.className = 'rating-bubble';
    peach.className = 'peach';
    bubble.classList.add(`glow-${value}`);
    peach.classList.add(`glow-${value}`, 'pop');
    // remove pop after animation so it can trigger again
    setTimeout(()=> peach.classList.remove('pop'), 420);
  });

  async function refreshTotalsAndSyncClient() {
    try {
      const r = await fetch('/api/total');
      if(!r.ok) throw new Error('no totals');
      const data = await r.json();
      const avg = data.totalResponses ? (data.totalRating / data.totalResponses).toFixed(2) : '‚Äî';
      currentInfo.textContent = `Current total points: ${data.totalRating} ‚Ä¢ Responses: ${data.totalResponses} ‚Ä¢ Average: ${avg}`;

      // FIX: if server didn't provide resetAt, use epoch so client treats it as reset (safe)
      const resetAt = data.resetAt ? new Date(data.resetAt) : new Date(0);

      const local = getSubmitted();
      if (local.submitted && local.at && local.at < resetAt) {
        // user's submission happened before server reset ‚Äî clear local state
        clearSubmittedLocal();
        setSubmittedUI(false);
      } else {
        setSubmittedUI(local.submitted);
      }
    } catch (e) {
      currentInfo.textContent = 'Totals unavailable right now.';
      console.error(e);
    }
  }

  // initial refresh + periodic refresh
  await refreshTotalsAndSyncClient();
  setInterval(refreshTotalsAndSyncClient, 5000);

  submitBtn.addEventListener('click', async ()=>{
    const rating = Number(slider.value);
    if(rating < 1 || rating > 10) { alert('Please pick a rating between 1 and 10'); return; }
    submitBtn.disabled = true;
    status.textContent = 'Submitting...';
    try{
      const res = await fetch('/api/submit', {
        method:'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ rating })
      });
      if(!res.ok) throw new Error('submit failed');
      // mark submitted with timestamp
      setSubmittedNow();
      setSubmittedUI(true);
      // refresh totals (and sync resetAt)
      await refreshTotalsAndSyncClient();
      document.getElementById('modalTitle').textContent = 'Thank you!';
      document.getElementById('modalText').textContent = `Your rating (${rating}) was recorded.`;
      modal.style.display = 'block';
    }catch(err){
      alert('Could not submit. Please try again.');
      console.error(err);
      setSubmittedUI(false);
    }
  });

  resetBtn.addEventListener('click', ()=>{
    // UI-only reset for changing selection before submit
    slider.value = 8;
    count.textContent = 8;
    bubble.className = 'rating-bubble glow-8';
    peach.className = 'peach glow-8';
  });

  modalClose.addEventListener('click', ()=> modal.style.display = 'none');

})();
</script>
</body>
</html>
